<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rahal & Rahala - Endless Runner</title>
    
    <!-- Tailwind CSS for UI Overlays -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phaser 3 Game Engine -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&family=Roboto:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        /* Background Color & Layout */
        body { 
            margin: 0; padding: 0; overflow: hidden; background-color: #13647a; 
            font-family: 'Roboto', sans-serif; height: 100vh; width: 100vw; 
            display: flex; justify-content: center; align-items: center;
        }
        #game-container { width: 100%; height: 100%; max-width: 100vh; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 10; }
        .interactive { pointer-events: auto; }
        .rtl { direction: rtl; font-family: 'Cairo', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }

        /* Custom Scrollbar for Instructions Box */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.4); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.6); }
        
        #admin-panel { display: none; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
        
        #particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; pointer-events: none; }
        .particle { position: absolute; background: rgba(255, 255, 255, 0.1); border-radius: 50%; bottom: -50px; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 0.3; } 90% { opacity: 0.3; } 100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; } }
        
        /* Fallbacks */
        img[src="assets/ui/logo.png"]:not([src]) { display: block; width: 200px; height: 100px; background: rgba(0,0,0,0.1); }
        img[src="assets/ui/oqlogo.png"]:not([src]) { display: block; width: 100px; height: 50px; background: rgba(0,0,0,0.1); }
        img[src="assets/ui/img.png"]:not([src]) { display: block; width: 128px; height: 128px; background: rgba(255,255,255,0.2); }
        img[src="assets/ui/menu.png"]:not([src]) { background-color: #13647a; }

        /* Mute Button */
        #mute-btn {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 50;
            background: rgba(0,0,0,0.5); color: white; border: 2px solid white; border-radius: 50%;
            width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: none; 
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="particles-container"></div>
    <div id="game-container"></div>
    <button id="mute-btn" onclick="toggleMute()" class="interactive">ğŸ”Š</button>

    <!-- INSTRUCTIONS SCREEN -->
    <div id="instructions-screen" class="overlay interactive bg-[#13647a] bg-opacity-95 flex-col z-[60] p-4">
        
        <!-- Language buttons for instructions -->
        <div class="absolute top-6 right-6 flex gap-2 z-20">
            <button onclick="setLang('en')" class="px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 rounded text-blue-800 font-bold shadow">EN</button>
            <button onclick="setLang('ar')" class="px-3 py-1 text-sm bg-green-100 hover:bg-green-200 rounded text-green-800 font-bold shadow">Ø¹Ø±Ø¨ÙŠ</button>
        </div>

        <!-- Scrollable Instructions Box -->
        <div class="bg-black/40 p-6 md:p-8 rounded-2xl w-full max-w-lg h-[75vh] border border-white/20 flex flex-col relative mt-12 shadow-2xl backdrop-blur-md">
            
            <!-- ENGLISH INSTRUCTIONS -->
            <div id="instructions-en" class="custom-scroll text-white overflow-y-auto pr-3 space-y-4 text-left">
                <h2 class="text-3xl font-extrabold text-yellow-400 mb-2">GAME INSTRUCTIONS</h2>
                <h3 class="text-xl font-bold mb-4">Energy for Virtue</h3>
                <p class="font-medium">Welcome to OQEPâ€™s Ramadan â€œRahhal and Rahhalaâ€ Game!</p>
                
                <h3 class="text-2xl font-bold text-yellow-400 mt-8 mb-2">Game Concept</h3>
                <p class="text-sm leading-relaxed text-gray-200">This is an infinite runner game where you explore Oman through three exciting levels, collecting coins and Ramadan lanterns along the way.</p>
                <p class="text-sm leading-relaxed text-gray-200">Each level represents a journey of virtue â€” inspired by OQEPâ€™s presence across the Sultanate and its community initiatives.</p>
                <h4 class="font-bold text-lg mt-4 text-blue-300">Your goal:</h4>
                <ul class="text-sm text-gray-200 space-y-1">
                    <li>âœ” Run as far as possible</li>
                    <li>âœ” Avoid obstacles</li>
                    <li>âœ” Collect coins</li>
                    <li>âœ” Complete levels</li>
                    <li>âœ” Achieve the highest score</li>
                </ul>
                <p class="mt-2 text-sm font-bold italic text-yellow-200">The further you run, the higher your score!</p>

                <h3 class="text-2xl font-bold text-yellow-400 mt-8 mb-2">How to Win</h3>
                <ul class="list-decimal list-inside ml-2 text-sm text-gray-200 space-y-2">
                    <li>Play the game and complete as many levels as possible.</li>
                    <li>After the game ends, click <span class="font-bold text-white">â€œShare Scoreâ€</span>.</li>
                    <li>Post your score on Instagram.</li>
                    <li>Tag <span class="font-bold text-blue-300">#OQEP #Ø·Ø§Ù‚ØªÙ†Ø§_Ù„Ù„Ø®ÙŠØ± #EnergyforVirtue</span></li>
                    <li>Make sure your profile is public at the time of participation.</li>
                    <li>You may play multiple times and share multiple scores to improve your ranking.</li>
                </ul>
                <p class="mt-4 font-bold text-yellow-300 p-3 bg-white/10 rounded border border-yellow-400/30">The Top 5 highest scores at the end of Ramadan 2026 will win a special gift from OQEP.</p>

                <hr class="my-8 border-white/20">

                <h2 class="text-3xl font-extrabold text-yellow-400 mb-6">TERMS & CONDITIONS</h2>
                <p class="mb-6 text-sm italic text-gray-300">By clicking â€œAccept & Play,â€ you agree to the following:</p>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Eligibility</h4>
                <ul class="list-disc list-inside ml-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Participation is open to residents of the Sultanate of Oman only.</li>
                    <li>Winners must present a valid Omani National ID to claim the prize.</li>
                    <li>Participants must be 18 years or older.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Participation Rules</h4>
                <ul class="list-disc list-inside ml-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Players may participate multiple times.</li>
                    <li>Multiple score submissions are allowed.</li>
                    <li>Only publicly shared and properly tagged posts will be considered valid.</li>
                    <li>OQEP reserves the right to verify authenticity of scores.</li>
                    <li>Any attempt to manipulate, hack, or misuse the platform will result in disqualification.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Winner Selection</h4>
                <ul class="list-disc list-inside ml-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>The Top 5 highest verified scores will be declared winners.</li>
                    <li>In case of tie scores, earliest submission will be considered.</li>
                    <li>Only one gift per individual will be awarded.</li>
                    <li>If the same individual appears multiple times on the leaderboard (including through multiple accounts or IDs), only one prize will be granted.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Prize Collection</h4>
                <ul class="list-disc list-inside ml-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Winners will be announced on OQEPâ€™s official social media platforms.</li>
                    <li>Winners must claim their prize within 15 days of the announcement.</li>
                    <li>Failure to claim within this period will result in forfeiture of the prize.</li>
                    <li>Prizes are non-transferable and cannot be exchanged for cash.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">General Conditions</h4>
                <ul class="list-disc list-inside ml-2 pb-6 text-sm text-gray-200 space-y-1">
                    <li>OQEP reserves the right to amend or cancel the competition at any time.</li>
                    <li>OQEPâ€™s decision regarding winners and eligibility is final.</li>
                    <li>By participating, players agree that OQEP may repost or feature their shared content for promotional purposes.</li>
                    <li>Personal data collected will be used solely for competition administration and verification.</li>
                </ul>
            </div>

            <!-- ARABIC INSTRUCTIONS -->
            <div id="instructions-ar" class="custom-scroll text-white overflow-y-auto pl-3 space-y-4 text-right rtl hidden font-['Cairo']">
                <h2 class="text-3xl font-extrabold text-yellow-400 mb-2">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
                <h3 class="text-xl font-bold mb-4">Ø·Ø§Ù‚ØªÙ†Ø§ Ù„Ù„Ø®ÙŠØ±</h3>
                <p class="font-medium">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù„Ø¹Ø¨Ø© Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø±Ù…Ø¶Ø§Ù†ÙŠØ© "Ø±Ø­Ø§Ù„ ÙˆØ±Ø­Ø§Ù„Ø©"!</p>
                
                <h3 class="text-2xl font-bold text-yellow-400 mt-8 mb-2">Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
                <p class="text-sm leading-relaxed text-gray-200">Ù‡ÙŠ Ù„Ø¹Ø¨Ø© Ø±ÙƒØ¶ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ ØªØ³ØªÙƒØ´Ù ÙÙŠÙ‡Ø§ Ø¹ÙÙ…Ø§Ù† Ø¹Ø¨Ø± Ø«Ù„Ø§Ø«Ø© Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ø´ÙˆÙ‚Ø©ØŒ ÙˆØªØ¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆÙÙˆØ§Ù†ÙŠØ³ Ø±Ù…Ø¶Ø§Ù† ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ.</p>
                <p class="text-sm leading-relaxed text-gray-200">ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ ÙŠÙ…Ø«Ù„ Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø®ÙŠØ± â€” Ù…Ø³ØªÙˆØ­Ø§Ø© Ù…Ù† ØªÙˆØ§Ø¬Ø¯ Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„Ø³Ù„Ø·Ù†Ø© ÙˆÙ…Ø¨Ø§Ø¯Ø±Ø§ØªÙ‡Ø§ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠØ©.</p>
                <h4 class="font-bold text-lg mt-4 text-blue-300">Ù‡Ø¯ÙÙƒ:</h4>
                <ul class="text-sm text-gray-200 space-y-1">
                    <li>âœ” Ø§Ø±ÙƒØ¶ Ù„Ø£Ø¨Ø¹Ø¯ Ù…Ø³Ø§ÙØ© Ù…Ù…ÙƒÙ†Ø©</li>
                    <li>âœ” ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª</li>
                    <li>âœ” Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</li>
                    <li>âœ” Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</li>
                    <li>âœ” Ø­Ù‚Ù‚ Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©</li>
                </ul>
                <p class="mt-2 text-sm font-bold italic text-yellow-200">ÙƒÙ„Ù…Ø§ Ø±ÙƒØ¶Øª Ù…Ø³Ø§ÙØ© Ø£Ø·ÙˆÙ„ØŒ Ø²Ø§Ø¯Øª Ù†ØªÙŠØ¬ØªÙƒ!</p>

                <h3 class="text-2xl font-bold text-yellow-400 mt-8 mb-2">ÙƒÙŠÙ ØªÙÙˆØ²</h3>
                <ul class="list-decimal list-inside mr-2 text-sm text-gray-200 space-y-2">
                    <li>Ø§Ù„Ø¹Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ£ÙƒÙ…Ù„ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.</li>
                    <li>Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ <span class="font-bold text-white">"Ø´Ø§Ø±Ùƒ Ø§Ù„Ù†ØªÙŠØ¬Ø©"</span>.</li>
                    <li>Ø§Ù†Ø´Ø± Ù†ØªÙŠØ¬ØªÙƒ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù….</li>
                    <li>Ø£Ø¶Ù Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª <span class="font-bold text-blue-300">#oqep#Ø·Ø§Ù‚ØªÙ†Ø§_Ù„Ù„Ø®ÙŠØ± #EnergyforVirtue</span></li>
                    <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ø§Ù… (Public) ÙˆÙ‚Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.</li>
                    <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù„Ø¹Ø¨ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„ØªØ­Ø³ÙŠÙ† ØªØ±ØªÙŠØ¨Ùƒ.</li>
                </ul>
                <p class="mt-4 font-bold text-yellow-300 p-3 bg-white/10 rounded border border-yellow-400/30">Ø£Ø¹Ù„Ù‰ 5 Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ù‡Ø§ÙŠØ© Ø´Ù‡Ø± Ø±Ù…Ø¶Ø§Ù† 2026 Ø³ÙŠÙÙˆØ²ÙˆÙ† Ø¨Ù‡Ø¯ÙŠØ© Ø®Ø§ØµØ© Ù…Ù† Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬.</p>

                <hr class="my-8 border-white/20">

                <h2 class="text-3xl font-extrabold text-yellow-400 mb-6">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</h2>
                <p class="mb-6 text-sm italic text-gray-300">Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ù…ÙˆØ§ÙÙ‚ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨"ØŒ ÙØ¥Ù†Ùƒ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙ„ÙŠ:</p>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</h4>
                <ul class="list-disc list-inside mr-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙØªÙˆØ­Ø© Ù„Ù„Ù…Ù‚ÙŠÙ…ÙŠÙ† ÙÙŠ Ø³Ù„Ø·Ù†Ø© Ø¹ÙÙ…Ø§Ù† ÙÙ‚Ø·.</li>
                    <li>ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¥Ø¨Ø±Ø§Ø² Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ø¹ÙÙ…Ø§Ù†ÙŠØ© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©.</li>
                    <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù…Ø± Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ 18 Ø¹Ø§Ù…Ø§Ù‹ Ø£Ùˆ Ø£ÙƒØ«Ø±.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h4>
                <ul class="list-disc list-inside mr-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>ÙŠØ­Ù‚ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.</li>
                    <li>ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª.</li>
                    <li>Ø³ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·.</li>
                    <li>ØªØ­ØªÙØ¸ Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ø§Ù„Ø­Ù‚ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</li>
                    <li>Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„ØªÙ„Ø§Ø¹Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø£Ùˆ Ø¥Ø³Ø§Ø¡Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ© Ø³ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†</h4>
                <ul class="list-disc list-inside mr-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù† Ø£ØµØ­Ø§Ø¨ Ø£Ø¹Ù„Ù‰ 5 Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ØªÙ…Ø¯Ø© ÙƒÙØ§Ø¦Ø²ÙŠÙ†.</li>
                    <li>ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ù…Ù† Ø­Ù‚Ù‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©.</li>
                    <li>Ø³ÙŠØªÙ… Ù…Ù†Ø­ Ù‡Ø¯ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ ÙØ±Ø¯.</li>
                    <li>Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ù†ÙØ³ Ø§Ù„ÙØ±Ø¯ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ø­ØªÙ‰ Ù„Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ùˆ Ù‡ÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©)ØŒ Ø³ÙŠØªÙ… Ù…Ù†Ø­Ù‡ Ø¬Ø§Ø¦Ø²Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h4>
                <ul class="list-disc list-inside mr-2 mb-6 text-sm text-gray-200 space-y-1">
                    <li>Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù† Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ù„Ù‰ Ù…Ù†ØµØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù€ Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬.</li>
                    <li>ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ø³ØªÙ„Ø§Ù… Ø¬ÙˆØ§Ø¦Ø²Ù‡Ù… Ø®Ù„Ø§Ù„ 15 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.</li>
                    <li>Ø¹Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø­Ù‚ ÙÙŠÙ‡Ø§.</li>
                    <li>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ù†Ù‚Ø¯Ø§Ù‹.</li>
                </ul>

                <h4 class="font-bold text-lg text-blue-300 mb-2">Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
                <ul class="list-disc list-inside mr-2 pb-6 text-sm text-gray-200 space-y-1">
                    <li>ØªØ­ØªÙØ¸ Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ø§Ù„Ø­Ù‚ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</li>
                    <li>Ù‚Ø±Ø§Ø± Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ø´Ø£Ù† Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ÙˆØ§Ù„Ø£Ù‡Ù„ÙŠØ© Ù‡Ùˆ Ù‚Ø±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ.</li>
                    <li>Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŒ ÙŠÙˆØ§ÙÙ‚ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¹Ù„Ù‰ Ø£Ù† Ø£ÙˆÙƒÙŠÙˆ Ù„Ù„Ø¥Ø³ØªÙƒØ´Ø§Ù ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ ÙŠØ­Ù‚ Ù„Ù‡Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± Ù…Ø­ØªÙˆØ§Ù‡Ù… Ø£Ùˆ Ø¹Ø±Ø¶Ù‡ Ù„Ø£ØºØ±Ø§Ø¶ ØªØ±ÙˆÙŠØ¬ÙŠØ©.</li>
                    <li>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù…Ø¹Ù‡Ø§ ÙÙ‚Ø· Ù„Ø£ØºØ±Ø§Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚.</li>
                </ul>
            </div>

        </div>

        <button id="btn-proceed" onclick="hideInstructions()" class="mt-6 px-12 py-4 bg-gradient-to-r from-yellow-400 to-yellow-600 text-black font-extrabold rounded-full hover:scale-105 transition transform shadow-2xl text-xl z-20 uppercase tracking-wider">
            Accept & Play
        </button>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="overlay interactive bg-black bg-opacity-30 backdrop-blur-sm flex-col overflow-hidden z-50">
        
        <!-- EXACT 1080x1920 NON-SCALABLE CONTAINERS FOR BG & ART -->
        <div class="absolute inset-0 flex justify-center items-center pointer-events-none z-0 overflow-hidden">
            <div style="width: 1080px; height: 1920px; max-width: 100vw; max-height: 100vh; aspect-ratio: 1080/1920; position: relative;">
                <img src="assets/ui/menu.png" class="absolute inset-0 w-full h-full object-cover blur-sm opacity-60" alt="">
                <img src="assets/ui/art.png" class="absolute inset-0 w-full h-full object-cover z-[5]" alt="">
            </div>
        </div>

        <div class="mb-6 z-20 relative flex flex-col items-center">
             <img src="assets/ui/oqlogo.png" id="ui-oqlogo" alt="OQ LOGO" class="max-w-[120px] mb-3 h-auto object-contain drop-shadow-md">
             <img src="assets/ui/logo.png" id="ui-logo" alt="GAME LOGO" class="max-w-[280px] h-auto object-contain drop-shadow-lg">
        </div>

        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl max-w-md w-full text-center relative border border-white/20 m-4 z-20">
            <div class="absolute top-4 right-4 flex gap-2 z-20">
                <button onclick="setLang('en')" class="px-2 py-1 text-sm bg-blue-100 hover:bg-blue-200 rounded text-blue-800 font-bold">EN</button>
                <button onclick="setLang('ar')" class="px-2 py-1 text-sm bg-green-100 hover:bg-green-200 rounded text-green-800 font-bold">Ø¹Ø±Ø¨ÙŠ</button>
            </div>
            <div class="space-y-4 text-left mt-4">
                <div>
                    <label id="lbl-name" class="block text-sm font-bold text-gray-700">Name</label>
                    <input type="text" id="inp-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#13647a] focus:border-[#13647a]">
                </div>
                
                <div class="pt-4">
                    <label id="lbl-char" class="block text-sm font-bold text-gray-700 mb-2">Choose Character</label>
                    <div class="flex gap-4 justify-center">
                        <div onclick="selectChar('rahal')" id="btn-rahal" class="cursor-pointer border-4 border-transparent hover:border-blue-400 rounded-lg p-2 bg-blue-50 w-1/2 transition-all duration-200 transform hover:scale-105">
                            <div class="w-full aspect-square flex items-center justify-center overflow-hidden rounded mb-1 bg-blue-200">
                                <img src="assets/ui/rahal_select.png" alt="Rahal" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div onclick="selectChar('rahala')" id="btn-rahala" class="cursor-pointer border-4 border-transparent hover:border-pink-400 rounded-lg p-2 bg-pink-50 w-1/2 transition-all duration-200 transform hover:scale-105">
                            <div class="w-full aspect-square flex items-center justify-center overflow-hidden rounded mb-1 bg-pink-200">
                                <img src="assets/ui/rahala_select.png" alt="Rahala" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="startGame()" id="btn-start" class="w-full bg-[#13647a] hover:bg-[#0f4f61] text-white py-3 rounded-lg font-bold transition transform hover:scale-105 shadow-lg mt-6">
                    START ADVENTURE
                </button>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="overlay interactive flex-col p-10 z-[100]">
        <div class="w-full max-w-4xl bg-gray-800 rounded-lg shadow-xl overflow-hidden border border-gray-700">
            <div class="bg-gray-900 p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Admin Dashboard (Global Scores)</h2>
                <button onclick="toggleAdmin()" class="text-gray-400 hover:text-white">âœ• Close</button>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left text-sm text-gray-400"><tbody id="admin-table-body"></tbody></table></div>
        </div>
    </div>

    <!-- GAME OVER / END SCREEN -->
    <div id="game-over-screen" class="overlay interactive hidden flex-col bg-black/50 backdrop-blur-sm text-white overflow-y-auto py-10 justify-center">
        
        <h2 id="end-name" class="text-6xl md:text-7xl font-bold mb-4 drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] text-center px-4 uppercase tracking-wider"></h2>
        <div class="text-4xl md:text-5xl mb-8 font-bold drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] text-yellow-400">
            <span id="end-score-lbl">Score:</span> <span id="final-score" class="text-white">0</span>
        </div>
        
        <!-- QR Code / Image Placeholder -->
        <div class="flex flex-col items-center mb-8">
            <img src="assets/ui/img.png" id="ui-qr" alt="Scan to Play" crossorigin="anonymous" class="w-32 h-32 md:w-40 md:h-40 object-contain bg-white/20 rounded-xl p-2 shadow-lg mb-2 backdrop-blur-sm">
            <p id="lbl-scan" class="text-sm md:text-base font-bold text-gray-200 uppercase tracking-widest drop-shadow-md">Scan to play</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col gap-5 w-full max-w-xs px-4 mb-8">
            <button id="btn-share" onclick="shareScore()" class="w-full py-4 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white font-bold rounded-full hover:scale-105 transition transform shadow-xl text-xl flex items-center justify-center gap-2">
                ğŸ“¸ Share
            </button>
            <button id="btn-playagain" onclick="location.reload()" class="w-full py-4 bg-white text-black font-bold rounded-full hover:bg-gray-200 transition transform hover:scale-105 shadow-xl text-xl flex items-center justify-center gap-2">
                ğŸ”„ Play Again
            </button>
        </div>

        <!-- GLOBAL LEADERBOARD SECTION -->
        <div class="w-full max-w-md bg-gray-800/90 rounded-lg p-4 mb-8 border border-gray-700 shadow-xl backdrop-blur-md">
            <h3 class="text-xl font-bold text-white mb-3 text-center border-b border-gray-600 pb-2">Top 5 Leaders</h3>
            <table class="w-full text-left text-sm text-gray-300">
                <thead class="bg-gray-900 text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-2">Rank</th>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2 text-right">Score</th>
                    </tr>
                </thead>
                <tbody id="gameover-leaderboard-body">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- TYPE MODULE to support Firebase Imports -->
    <script type="module">
        // ==========================================
        // FIREBASE GLOBAL LEADERBOARD SETUP
        // ==========================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

        // âš ï¸ DEVELOPER: Replace these values with your Firebase Project Config
        const firebaseConfig = {
            apiKey: "AIzaSyD42Pncs-uhUkb1CTeixwVNDctsF73GKV8",
            authDomain: "rahalscores.firebaseapp.com",
            projectId: "rahalscores",
            storageBucket: "rahalscores.firebasestorage.app",
            messagingSenderId: "562530648403",
            appId: "1:562530648403:web:dda7c6653b343371b221a6"
        };

        let app, db;
        let useFirebase = false;

        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                useFirebase = true;
                console.log("Firebase initialized! Global Leaderboard Active.");
            } catch (error) {
                console.error("Firebase init error:", error);
            }
        }

        // ==========================================
        // CONFIG & DATA
        // ==========================================
        const isPreviewEnv = window.location.protocol === 'blob:' || window.location.protocol === 'data:' || window.location.protocol === 'file:';
        const DEMO_MODE = isPreviewEnv ? true : false;
        
        const LOGICAL_WIDTH = 1080;
        const LOGICAL_HEIGHT = 1920;
        const BLOCK_SIZE = 135; 
        const GROUND_Y = Math.floor(LOGICAL_HEIGHT - (BLOCK_SIZE * 3.5));
        
        const LEVEL_NAMES = {
            1: { en: "Musandam", ar: "Ù…Ø³Ù†Ø¯Ù…" },
            2: { en: "Marsa", ar: "Ù…Ø±Ø³Ù‰" },
            3: { en: "Bisat desert", ar: "ØµØ­Ø±Ø§Ø¡ Ø¨Ø³Ø§Ø·" }
        };

        const LETTER_PATTERNS = {
            'O': [" XXX ","X   X","X   X"," XXX "],
            'Q': [" XXX ","X   X","X X X"," XXXX"],
            'E': ["XXXXX","X    ","XXXX ","X    ","XXXXX"],
            'P': ["XXXX ","X   X","XXXX ","X    ","X    "]
        };

        const GAME_CONFIG = {
            gravity: 3000, 
            startSpeed: 600,  
            maxSpeed: 1800,    
            acceleration: 0.1, 
            jumpForce: -2000 
        };

        let userData = { name: "", character: "rahal", lang: "en" };
        const DB_KEY = 'rahal_game_db';
        const I18N = {
            en: { name: "Name", char: "Choose Character", start: "START ADVENTURE", score: "Score", share: "Share", playagain: "Play Again", win: "ğŸ†", proceed: "Accept & Play", scan: "Scan to play" },
            ar: { name: "Ø§Ù„Ø§Ø³Ù…", char: "Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®ØµÙŠØ©", start: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©", score: "Ø§Ù„Ù†ØªÙŠØ¬Ø©", share: "Ø´Ø§Ø±Ùƒ", playagain: "Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", win: "ğŸ†", proceed: "Ù…ÙˆØ§ÙÙ‚ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨", scan: "Ø§Ù…Ø³Ø­ Ù„Ù„Ø¹Ø¨" }
        };

        let gameInstance = null;
        let isMuted = false;

        // ==========================================
        // EXPORT TO WINDOW
        // ==========================================
        window.setLang = setLang;
        window.selectChar = selectChar;
        window.startGame = startGame;
        window.toggleAdmin = toggleAdmin;
        window.shareScore = shareScore;
        window.toggleMute = toggleMute;
        window.hideInstructions = hideInstructions;

        // ==========================================
        // UI & SHARE FUNCTIONS
        // ==========================================
        function hideInstructions() {
            document.getElementById('instructions-screen').style.display = 'none';
        }

        function setLang(l) { userData.lang = l; renderUI(); }
        function selectChar(c) { userData.character = c; renderUI(); }
        
        function renderUI() {
            const t = I18N[userData.lang];
            
            // Registration Form
            document.getElementById('lbl-name').innerText = t.name;
            document.getElementById('lbl-char').innerText = t.char;
            document.getElementById('btn-start').innerText = t.start;
            
            // Buttons
            document.getElementById('btn-proceed').innerText = t.proceed;
            document.getElementById('end-score-lbl').innerText = t.score + ':';
            document.getElementById('lbl-scan').innerText = t.scan;
            document.getElementById('btn-share').innerHTML = `ğŸ“¸ ${t.share}`;
            document.getElementById('btn-playagain').innerHTML = `ğŸ”„ ${t.playagain}`;

            // Handle Instructions Language Switch
            if(userData.lang === 'ar') {
                document.getElementById('instructions-en').classList.add('hidden');
                document.getElementById('instructions-ar').classList.remove('hidden');
                document.getElementById('start-screen').classList.add('rtl');
            } else {
                document.getElementById('instructions-en').classList.remove('hidden');
                document.getElementById('instructions-ar').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('rtl');
            }

            // Character Selection highlight
            document.getElementById('btn-rahal').classList.remove('border-blue-500', 'ring-2');
            document.getElementById('btn-rahala').classList.remove('border-pink-500', 'ring-2');
            if(userData.character === 'rahal') document.getElementById('btn-rahal').classList.add('border-blue-500', 'ring-2');
            else document.getElementById('btn-rahala').classList.add('border-pink-500', 'ring-2');
        }

        function startGame() {
            const n = document.getElementById('inp-name').value;
            if(!n) return alert(userData.lang === 'en' ? "Missing Name" : "Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            
            userData.name = n;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('mute-btn').style.display = 'flex';
            if(!document.getElementById('particles-container').innerHTML) createParticles();
            
            gameInstance = new Phaser.Game({
                type: Phaser.AUTO, 
                parent: 'game-container',
                scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: LOGICAL_WIDTH, height: LOGICAL_HEIGHT },
                physics: { 
                    default: 'arcade', 
                    arcade: { gravity: { y: GAME_CONFIG.gravity }, debug: false, tileBias: 128, fps: 120 } 
                }, 
                scene: MainScene, 
                transparent: true,
                preserveDrawingBuffer: true
            });
        }

        async function shareScore() {
            if (!gameInstance) return;
            try {
                const phaserCanvas = gameInstance.canvas;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = phaserCanvas.width;
                tempCanvas.height = phaserCanvas.height;
                const ctx = tempCanvas.getContext('2d');
                
                // 1. Draw base game canvas
                ctx.drawImage(phaserCanvas, 0, 0);
                
                // 2. Add dark overlay
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                const nameText = document.getElementById('end-name').innerText;
                const scoreVal = document.getElementById('final-score').innerText;
                const scoreText = I18N[userData.lang].score + ': ' + scoreVal;
                const scanText = I18N[userData.lang].scan;
                
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const centerX = tempCanvas.width / 2;
                const centerY = tempCanvas.height / 2;
                
                // Enable shadows
                ctx.shadowColor = "rgba(0,0,0,0.8)";
                ctx.shadowBlur = 10;
                
                // 3. Draw Name (higher up)
                ctx.font = `bold ${Math.floor(tempCanvas.height * 0.06)}px sans-serif`;
                ctx.fillStyle = '#ffffff';
                ctx.fillText(nameText, centerX, centerY - 250);
                
                // 4. Draw Score
                ctx.font = `bold ${Math.floor(tempCanvas.height * 0.04)}px sans-serif`;
                ctx.fillStyle = '#facc15';
                ctx.fillText(scoreText, centerX, centerY - 120);
                
                // 5. Draw QR Code Image
                const qrImgElement = document.getElementById('ui-qr');
                const qrSize = Math.floor(tempCanvas.width * 0.25); 
                const qrX = centerX - (qrSize / 2);
                const qrY = centerY - 10;
                
                if (qrImgElement && qrImgElement.complete && qrImgElement.naturalWidth > 0) {
                    ctx.shadowBlur = 0; 
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                    
                    if(ctx.roundRect) {
                        ctx.beginPath();
                        ctx.roundRect(qrX - 20, qrY - 20, qrSize + 40, qrSize + 40, 20);
                        ctx.fill();
                    } else {
                        ctx.fillRect(qrX - 20, qrY - 20, qrSize + 40, qrSize + 40);
                    }
                    
                    ctx.drawImage(qrImgElement, qrX, qrY, qrSize, qrSize);
                }
                
                // 6. Draw Scan text
                ctx.shadowColor = "rgba(0,0,0,0.8)";
                ctx.shadowBlur = 5;
                ctx.font = `bold ${Math.floor(tempCanvas.height * 0.025)}px sans-serif`;
                ctx.fillStyle = '#e5e7eb';
                ctx.fillText(scanText.toUpperCase(), centerX, qrY + qrSize + 60);
                
                const dataUrl = tempCanvas.toDataURL('image/png');
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                const file = new File([blob], 'rahal_score.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Rahal & Rahala',
                        text: `Check out my score (${scoreVal}) in Rahal & Rahala!`
                    });
                } else {
                    const win = window.open();
                    win.document.write(`
                        <body style="background:#111; color:#fff; text-align:center; font-family:sans-serif; margin:0; padding:20px;">
                            <h2>Long-press or Right-click the image to save!</h2>
                            <p>Then you can share it anywhere.</p>
                            <img src="${dataUrl}" style="max-width: 100%; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
                        </body>
                    `);
                }
            } catch (err) {
                console.error("Error sharing:", err);
                alert("Could not share automatically. Please take a manual screenshot!");
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            if(gameInstance && gameInstance.sound) gameInstance.sound.mute = isMuted;
        }

        window.addEventListener('keydown', e => { 
            if(e.ctrlKey && e.code === 'Space') { e.preventDefault(); toggleAdmin(); }
        });

        // ==========================================
        // FIREBASE DATABASE LOGIC
        // ==========================================

        async function toggleAdmin() {
            const p = document.getElementById('admin-panel');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            
            if(p.style.display === 'flex') {
                document.getElementById('admin-table-body').innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading Data...</td></tr>';
                let data = [];
                
                if(useFirebase) {
                    try {
                        const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(100));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((doc) => {
                            data.push(doc.data());
                        });
                    } catch(e) {
                        console.error("Failed to fetch admin data from Firebase", e);
                        data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                    }
                } else {
                    data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                }
                
                const html = data.sort((a,b)=>b.score-a.score).map(u => `
                    <tr class="border-b border-gray-700">
                        <td class="p-2 text-white">${u.name}</td>
                        <td class="p-2 capitalize">${u.character||'-'}</td>
                        <td class="p-2 text-yellow-400">${u.score}</td>
                        <td class="p-2 text-xs">${new Date(u.date).toLocaleDateString()}</td>
                    </tr>`).join('');
                document.getElementById('admin-table-body').innerHTML = html || '<tr><td colspan="4" class="p-4">No data</td></tr>';
            }
        }

        async function saveScore(s) {
            const scoreData = { ...userData, score: s, date: new Date().toISOString() };
            const d = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            d.push(scoreData);
            localStorage.setItem(DB_KEY, JSON.stringify(d));

            if (useFirebase) {
                try { await addDoc(collection(db, "leaderboard"), scoreData); } 
                catch (e) { console.error("Error adding score to Firebase: ", e); }
            }
        }

        async function renderGameOverLeaderboard() {
            const tbody = document.getElementById('gameover-leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Loading Global Scores...</td></tr>';
            
            let top5 = [];
            if (useFirebase) {
                try {
                    const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(5));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => { top5.push(doc.data()); });
                } catch (e) {
                    console.error("Error fetching global scores: ", e);
                    const data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                    top5 = data.sort((a,b)=>b.score-a.score).slice(0, 5);
                }
            } else {
                const data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                top5 = data.sort((a,b)=>b.score-a.score).slice(0, 5);
            }

            if(top5.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No scores yet</td></tr>'; 
                return; 
            }
            
            tbody.innerHTML = top5.map((u, i) => `
                <tr class="border-b border-gray-700 bg-gray-800 bg-opacity-50 hover:bg-gray-700">
                    <td class="px-4 py-2 font-bold text-gray-400">#${i+1}</td>
                    <td class="px-4 py-2 text-white flex items-center gap-2"><span class="text-xs ${u.character === 'rahal' ? 'text-blue-400' : 'text-pink-400'}">â—</span> ${u.name}</td>
                    <td class="px-4 py-2 text-yellow-400 font-bold text-right">${u.score}</td>
                </tr>`).join('');
        }

        function createParticles() {
            const container = document.getElementById('particles-container');
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                const size = Math.random() * 20 + 10;
                const left = Math.random() * 100;
                const duration = Math.random() * 10 + 5;
                const delay = Math.random() * 5;
                p.style.width = `${size}px`; p.style.height = `${size}px`; p.style.left = `${left}%`;
                p.style.animationDuration = `${duration}s`; p.style.animationDelay = `${delay}s`;
                container.appendChild(p);
            }
        }

        // ==========================================
        // PHASER ENGINE
        // ==========================================
        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
                this.score = 0;
                this.lives = 3;
                this.level = 1;
                this.distance = 0;
                this.currentSpeed = GAME_CONFIG.startSpeed;
                this.isGameOver = false;
                
                // Trackers
                this.nextSpawnX = 0; 
                this.lastObstacleX = -1000;
                this.lastAirObstacleX = -1000;
                this.lastPowerupTime = 0; 
                this.lastOQEPTime = 0; 
                this.lifePowerupSpawned = false; 
                
                this.gameStartTime = 0;
                this.levelStartTime = 0; 
                this.portalSpawned = false;
                this.coinPatternBarrier = 0; 

                this.hasDoubleJump = false;
                this.jumpsUsed = 0;
                this.jumpBufferTime = 0;
                
                this.isInvincible = false;
                this.isStunned = false; 
                this.wasTouchingDown = false;
                
                this.safeStartDuration = 3000; 
            }

            preload() {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;
                
                // Loading UI Background Box
                const progressBox = this.add.graphics();
                progressBox.fillStyle(0x000000, 0.8);
                progressBox.fillRect(width / 2 - 260, height / 2 - 30, 520, 60);
                
                // Loading UI Progress Bar
                const progressBar = this.add.graphics();
                
                // Text for Loading
                const loadingTextStr = userData.lang === 'ar' ? '...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„' : 'Loading...';
                const loadingText = this.make.text({
                    x: width / 2,
                    y: height / 2 - 80,
                    text: loadingTextStr,
                    style: { font: 'bold 40px Cairo', fill: '#ffffff' }
                }).setOrigin(0.5, 0.5);
                
                // Percent Value
                const percentText = this.make.text({
                    x: width / 2,
                    y: height / 2,
                    text: '0%',
                    style: { font: 'bold 24px Roboto', fill: '#ffffff' }
                }).setOrigin(0.5, 0.5);
                
                // Please Wait message
                const waitTextStr = userData.lang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„...' : 'Please wait, first time to load takes longer...';
                const pleaseWaitText = this.make.text({
                    x: width / 2,
                    y: height / 2 + 80,
                    text: waitTextStr,
                    style: { font: 'bold 24px Cairo', fill: '#facc15' }
                }).setOrigin(0.5, 0.5);
                
                // Progress Event
                this.load.on('progress', function (value) {
                    percentText.setText(parseInt(value * 100) + '%');
                    progressBar.clear();
                    progressBar.fillStyle(0x00ff00, 1);
                    progressBar.fillRect(width / 2 - 250, height / 2 - 20, 500 * value, 40);
                });
                
                // Complete Event
                this.load.on('complete', function () {
                    progressBar.destroy();
                    progressBox.destroy();
                    loadingText.destroy();
                    percentText.destroy();
                    pleaseWaitText.destroy();
                });

                const g = this.make.graphics();
                // Round Particle
                g.fillStyle(0xffffff); g.fillCircle(16,16,16); g.generateTexture('particle_round', 32, 32); g.clear();
                
                // 5-Point Star
                g.fillStyle(0xffffff); g.beginPath();
                let points = 5, outer = 25, inner = 12;
                for(let i=0; i<points*2; i++) {
                    const r = (i%2 === 0) ? outer : inner;
                    const a = (Math.PI / points) * i;
                    const x = 32 + r * Math.sin(a);
                    const y = 32 + r * Math.cos(a);
                    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
                }
                g.closePath(); g.fillPath(); g.generateTexture('particle_star', 64, 64); g.clear();

                // 4-Point Star (NEW for coins)
                g.fillStyle(0xffffff); g.beginPath();
                points = 4; outer = 20; inner = 8;
                for(let i=0; i<points*2; i++) {
                    const r = (i%2 === 0) ? outer : inner;
                    const a = (Math.PI / points) * i;
                    const x = 32 + r * Math.sin(a);
                    const y = 32 + r * Math.cos(a);
                    if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
                }
                g.closePath(); g.fillPath(); g.generateTexture('particle_star_4', 64, 64); g.clear();

                const isPreviewEnv = window.location.protocol === 'blob:' || window.location.protocol === 'data:' || window.location.protocol === 'file:';
                
                if(isPreviewEnv) {
                    this.createDemoAssets();
                } else {
                    // ALWAYS PRELOAD AUDIO (Decoupled from DEMO_MODE, but only if not in preview to avoid URL errors)
                    this.load.audio('bgm', 'assets/audio/gamebg.mp3');
                    this.load.audio('sfx_coin', 'assets/audio/coin.wav');
                    this.load.audio('sfx_power', 'assets/audio/power.mp3');
                    this.load.audio('sfx_hit', 'assets/audio/hit.mp3');

                    this.load.image('life_icon', 'assets/ui/life_icon.png');
                    this.load.image('menu', 'assets/ui/menu.png');
                    ['rahal','rahala'].forEach(c => {
                        this.load.image(`${c}_run_1`, `assets/characters/${c}_run_1.png`);
                        this.load.image(`${c}_run_2`, `assets/characters/${c}_run_2.png`);
                        this.load.image(`${c}_run_3`, `assets/characters/${c}_run_3.png`); 
                        this.load.image(`${c}_run_4`, `assets/characters/${c}_run_4.png`); 
                        this.load.image(`${c}_jump`, `assets/characters/${c}_jump.png`); 
                        this.load.image(`${c}_hit`, `assets/characters/${c}_hit.png`);
                        this.load.image(`${c}_fall`, `assets/characters/${c}_fall.png`);
                    });
                    this.load.image('shield_item', 'assets/powerups/shield_item.png');
                    this.load.image('shield_overlay', 'assets/powerups/shield_overlay.png');
                    this.load.image('magnet_item', 'assets/powerups/magnet_item.png');
                    this.load.image('magnet_effect', 'assets/powerups/magnet_effect.png');
                    this.load.image('doublejump_item', 'assets/powerups/doublejump_item.png'); 
                    ['1','2','3'].forEach(i => this.load.image(`portal_${i}`, `assets/portal/portal_${i}.png`));
                    for(let i=1; i<=5; i++) {
                        this.load.image(`bg_${i}`, `assets/level${i}/bg.png`);
                        this.load.image(`block_${i}`, `assets/level${i}/block.png`);
                        this.load.image(`obstacle_${i}`, `assets/level${i}/obstacle.png`);
                        this.load.image(`obstacle_air_${i}_1`, `assets/level${i}/obstacle_air_1.png`);
                        this.load.image(`obstacle_air_${i}_2`, `assets/level${i}/obstacle_air_2.png`);
                        this.load.image(`coin_${i}`, `assets/level${i}/coin.png`);
                    }
                }
            }

            create() {
                // ALWAYS INIT AUDIO
                try {
                    this.sound.stopAll();
                    this.bgMusic = this.sound.add('bgm', { loop: true, volume: 0.5 });
                    this.bgMusic.play();
                    this.coinSound = this.sound.add('sfx_coin', { volume: 0.6 });
                    this.powerSound = this.sound.add('sfx_power', { volume: 0.8 });
                    this.hitSound = this.sound.add('sfx_hit', { volume: 0.8 });
                } catch(e) {
                    console.log('Audio init failed or files missing.', e);
                }

                this.gameStartTime = this.time.now;
                this.levelStartTime = this.time.now;
                this.lastPowerupTime = this.time.now; 
                this.lastOQEPTime = this.time.now;
                this.isInvincible = true; 
                this.isStunned = false;
                this.lifePowerupSpawned = false;
                const c = userData.character;
                
                this.anims.create({ key: 'run', frames: [{ key: `${c}_run_1` }, { key: `${c}_run_2` }, { key: `${c}_run_3` }, { key: `${c}_run_4` }], frameRate: 12, repeat: -1 });
                this.anims.create({ key: 'portal', frames: [{key:'portal_1'},{key:'portal_2'},{key:'portal_3'}], frameRate: 10, repeat: -1 });
                for(let i=1; i<=5; i++) {
                    this.anims.create({ key: `fly_${i}`, frames: [{ key: `obstacle_air_${i}_1` }, { key: `obstacle_air_${i}_2` }], frameRate: 6, repeat: -1, yoyo: true });
                }

                // STATIC BG
                this.bg = this.add.tileSprite(0, 0, this.scale.width, this.scale.height, `bg_${this.level}`).setOrigin(0,0).setScrollFactor(0);

                // --- NEW GROUP STRUCTURE ---
                this.groundSolids = this.physics.add.group({ immovable: true, allowGravity: false }); // TOP GROUND ONLY
                this.hangingBlocks = this.physics.add.group({ immovable: true, allowGravity: false }); // HANGING PLATS
                this.decorLayer = this.add.group(); 
                this.obstacles = this.physics.add.group({ allowGravity: false });
                this.coins = this.physics.add.group({ allowGravity: false });
                this.powerups = this.physics.add.group({ allowGravity: false });
                this.portals = this.physics.add.group({ allowGravity: false });

                // SPAWN CHARACTER (Middle Left Drop)
                const spawnY = this.scale.height * 0.5; // Middle of screen vertically
                this.player = this.physics.add.sprite(200, spawnY, `${c}_run_1`);
                this.player.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE);
                // COLLISION FIX
                this.player.refreshBody();
                this.player.body.setSize(BLOCK_SIZE * 0.5, BLOCK_SIZE * 0.9);
                this.player.body.setOffset(BLOCK_SIZE * 0.25, BLOCK_SIZE * 0.1);
                
                this.player.setCollideWorldBounds(true);
                this.physics.world.setBoundsCollision(true, true, true, false);
                this.player.play('run');

                this.shieldFx = this.add.sprite(0,0,'shield_overlay').setVisible(false).setAlpha(0.6).setDisplaySize(BLOCK_SIZE*1.5, BLOCK_SIZE*1.5);
                this.magnetFx = this.add.sprite(0,0,'magnet_effect').setVisible(false).setAlpha(0.5).setDisplaySize(BLOCK_SIZE*2, BLOCK_SIZE*2);

                this.nextSpawnX = 0;
                this.createGroundSegment(20); 

                // COLLIDE WITH SOLID GROUND & HANGING BLOCKS
                this.physics.add.collider(this.player, this.groundSolids);
                this.physics.add.collider(this.player, this.hangingBlocks);
                
                this.physics.add.overlap(this.player, this.obstacles, this.hitObstacle, null, this);
                this.physics.add.overlap(this.player, this.coins, (p,c)=> { this.collectCoin(p, c); }, null, this);
                this.physics.add.overlap(this.player, this.powerups, this.collectPowerup, null, this);
                this.physics.add.overlap(this.player, this.portals, this.enterPortal, null, this);

                this.input.keyboard.on('keydown-SPACE', this.tryJump, this);
                this.input.on('pointerdown', this.tryJump, this);
                this.input.keyboard.on('keyup-SPACE', this.cutJump, this);
                this.input.on('pointerup', this.cutJump, this);

                this.createHUD();
                this.showLevelName();

                // SPAWN INVINCIBILITY
                this.tweens.add({
                    targets: this.player, alpha: 0.5, duration: 100, yoyo: true, repeat: 15,
                    onComplete: () => { this.isInvincible = false; this.player.alpha = 1; }
                });
            }

            // DELTA UPDATE FIX for 120Hz Screens
            update(time, delta) {
                if(this.isGameOver) return;

                // Stop updates during stun
                if (this.isStunned) {
                    this.player.setTexture(`${userData.character}_hit`);
                    return;
                }

                const isTouchingDown = this.player.body.touching.down;

                if (isTouchingDown && !this.wasTouchingDown) {
                    this.jumpsUsed = 0;
                    if (time < this.jumpBufferTime) {
                        this.doJump();
                        this.jumpBufferTime = 0;
                    }
                }
                this.wasTouchingDown = isTouchingDown;

                if (!isTouchingDown) {
                    this.player.setTexture(`${userData.character}_jump`);
                } else {
                    if (this.player.anims.currentAnim?.key !== 'run') this.player.play('run', true);
                }

                // FRAME-RATE INDEPENDENT ACCELERATION & SHIFT
                const timeScale = delta / 16.666;
                if(this.currentSpeed < GAME_CONFIG.maxSpeed) {
                    this.currentSpeed += GAME_CONFIG.acceleration * timeScale;
                }

                const shift = this.currentSpeed * (delta / 1000);

                [this.groundSolids, this.hangingBlocks, this.obstacles, this.coins, this.powerups, this.portals].forEach(g => {
                    g.children.iterate(child => {
                        if(child) {
                            child.x -= shift;
                            if(child.x < -300) child.destroy(); 
                        }
                    });
                });
                
                this.decorLayer.children.iterate(child => {
                    if(child) {
                        child.x -= shift;
                        if(child.x < -300) child.destroy();
                    }
                });

                this.nextSpawnX -= shift;
                this.coinPatternBarrier -= shift;

                // GAPLESS GENERATION LOGIC
                let rightmostX = -1000;
                this.groundSolids.children.iterate(child => {
                    if (child.x > rightmostX) rightmostX = child.x;
                });
                
                if (rightmostX < this.scale.width + 200) {
                    this.createGroundSegment(Phaser.Math.Between(10, 20)); 
                }

                if(this.hasShield) this.shieldFx.setPosition(this.player.x, this.player.y);
                if(this.hasMagnet) {
                    this.magnetFx.setPosition(this.player.x, this.player.y);
                    this.coins.children.iterate(c => {
                        if(c && Phaser.Math.Distance.Between(this.player.x,this.player.y,c.x,c.y)<800) this.physics.moveToObject(c,this.player,1800);
                    });
                }

                if(this.player.y > this.scale.height) this.takeDamage('fall');
            }

            tryJump() {
                if (this.isStunned) return; 
                if (this.player.body.touching.down) {
                    this.doJump();
                } else {
                    if (this.hasDoubleJump && this.jumpsUsed < 2) {
                        this.doJump();
                    } else {
                        this.jumpBufferTime = this.time.now + 150; 
                    }
                }
            }

            doJump() {
                this.player.setVelocityY(GAME_CONFIG.jumpForce);
                this.jumpsUsed++;
                if (this.jumpsUsed > 1) {
                    const puff = this.add.circle(this.player.x, this.player.y + 20, 20, 0x00ffff, 0.5);
                    this.tweens.add({targets:puff, scale:2, alpha:0, duration:200, onComplete:()=>puff.destroy()});
                }
            }

            cutJump() {
                if(this.player.body.velocity.y < -100) this.player.setVelocityY(this.player.body.velocity.y * 0.5);
            }
            
            createGroundSegment(count) {
                if (this.time.now - this.levelStartTime > 60000 && this.portals.countActive() === 0 && !this.portalSpawned) {
                    const portalX = this.nextSpawnX + (BLOCK_SIZE * 3);
                    const portal = this.portals.create(portalX, this.scale.height / 2, 'portal_1');
                    portal.play('portal');
                    portal.setDisplaySize(BLOCK_SIZE * 2.5, this.scale.height);
                    portal.body.setSize(BLOCK_SIZE * 2.5, this.scale.height);
                    portal.body.setAllowGravity(false);
                    this.portalSpawned = true;
                    count = 12; 
                }

                if (this.distance > 10 && Math.random() < 0.35 && !this.portalSpawned) {
                    const gapSize = Phaser.Math.Between(3, 5);
                    this.nextSpawnX += (gapSize * BLOCK_SIZE);
                }

                const topY = Math.floor(GROUND_Y);

                for (let i = 0; i < count; i++) {
                    const x = this.nextSpawnX;
                    
                    const block = this.groundSolids.create(x, topY, `block_${this.level}`);
                    block.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE);
                    block.refreshBody(); 
                    block.body.setSize(BLOCK_SIZE, BLOCK_SIZE); 
                    
                    block.body.immovable = true;
                    block.body.allowGravity = false;
                    block.body.checkCollision.left = false;
                    block.body.checkCollision.right = false;

                    for(let j=1; j<4; j++) {
                        const y = topY + (j * BLOCK_SIZE) - 2;
                        const dBlock = this.decorLayer.create(x, y, `block_${this.level}`);
                        dBlock.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE);
                    }

                    if (!this.portalSpawned) {
                        if (this.time.now - this.gameStartTime > this.safeStartDuration) {
                            if (Math.random() < 0.05) { 
                                const type = Phaser.Math.Between(1, 3);
                                this.spawnHangingPattern(type, x, topY - (BLOCK_SIZE * 3.5)); 
                            }
                            if (Math.random() < 0.2) this.spawnItem(x, topY - (BLOCK_SIZE * 0.8));
                        }
                    }

                    this.nextSpawnX += (BLOCK_SIZE - 2);
                }

                this.distance += count;
            }

            spawnHangingPattern(type, startX, startY) {
                if (type === 1) { 
                    for(let i=0; i<3; i++) {
                        let plat1 = this.hangingBlocks.create(startX + (i*BLOCK_SIZE), startY, `block_${this.level}`);
                        plat1.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE); plat1.refreshBody(); plat1.body.setSize(BLOCK_SIZE, BLOCK_SIZE); plat1.body.immovable = true; plat1.body.allowGravity = false; 
                        if(i===1 && Math.random()<0.5) this.spawnItem(plat1.x, plat1.y - BLOCK_SIZE);
                    }
                } else if (type === 2) { 
                    for(let i=0; i<4; i++) {
                        let plat2 = this.hangingBlocks.create(startX + (i*BLOCK_SIZE), startY, `block_${this.level}`);
                        plat2.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE); plat2.refreshBody(); plat2.body.setSize(BLOCK_SIZE, BLOCK_SIZE); plat2.body.immovable = true; plat2.body.allowGravity = false; 
                        if(i===2 && Math.random()<0.5) this.spawnItem(plat2.x, plat2.y - BLOCK_SIZE);
                    }
                } else if (type === 3) { 
                    let b1 = this.hangingBlocks.create(startX, startY, `block_${this.level}`);
                    b1.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE); b1.refreshBody(); b1.body.setSize(BLOCK_SIZE, BLOCK_SIZE); b1.body.immovable = true; b1.body.allowGravity = false; 
                    let currentX = startX + BLOCK_SIZE + 200;
                    const step2Y = startY - (BLOCK_SIZE * 1.2); 
                    for(let i=0; i<3; i++) {
                        let plat3 = this.hangingBlocks.create(currentX + (i*BLOCK_SIZE), step2Y, `block_${this.level}`);
                        plat3.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE); plat3.refreshBody(); plat3.body.setSize(BLOCK_SIZE, BLOCK_SIZE); plat3.body.immovable = true; plat3.body.allowGravity = false;
                    }
                    currentX = currentX + (3*BLOCK_SIZE) + 200;
                    const step3Y = step2Y - (BLOCK_SIZE * 1.2); 
                    for(let i=0; i<4; i++) {
                        let plat4 = this.hangingBlocks.create(currentX + (i*BLOCK_SIZE), step3Y, `block_${this.level}`);
                        plat4.setDisplaySize(BLOCK_SIZE, BLOCK_SIZE); plat4.refreshBody(); plat4.body.setSize(BLOCK_SIZE, BLOCK_SIZE); plat4.body.immovable = true; plat4.body.allowGravity = false;
                        if (i === 3) {
                            const pTypes = ['shield', 'magnet', 'doublejump'];
                            const pType = pTypes[Phaser.Math.Between(0,2)];
                            this.spawnFloatingItem(plat4.x, plat4.y - BLOCK_SIZE, pType);
                        }
                    }
                }
            }

            spawnItem(x, y) {
                if (this.time.now - this.gameStartTime < this.safeStartDuration) return;

                if (this.level > 1 && !this.lifePowerupSpawned && this.time.now - this.levelStartTime > 3000) {
                    this.spawnFloatingItem(x, y - (BLOCK_SIZE * 1.5), 'life');
                    this.lifePowerupSpawned = true;
                    return;
                }

                const r = Math.random();
                const unsafe = Math.abs(x - this.lastObstacleX) < BLOCK_SIZE*3 || Math.abs(x - this.lastAirObstacleX) < BLOCK_SIZE*3; 
                const tooCloseForObstacle = Math.abs(x - Math.max(this.lastObstacleX, this.lastAirObstacleX)) < (BLOCK_SIZE * 6);

                if (this.time.now - this.lastOQEPTime > 25000) {
                    if (!unsafe && x > this.coinPatternBarrier) {
                        this.spawnFullWordPattern(x, y - (BLOCK_SIZE * 2));
                        this.lastOQEPTime = this.time.now;
                        this.coinPatternBarrier = x + (BLOCK_SIZE * 15); 
                        return; 
                    }
                }

                if (r < 0.6) { 
                    if (unsafe) return;
                    if (x > this.coinPatternBarrier) {
                        const coinRand = Math.random();
                        if (coinRand < 0.15) {
                            this.spawnCoinArc(x, y - (BLOCK_SIZE));
                            this.coinPatternBarrier = x + (BLOCK_SIZE * 4); 
                        } else if (coinRand < 0.3) {
                            this.spawnCoinLine(x, y - (BLOCK_SIZE*0.5)); 
                            this.coinPatternBarrier = x + (BLOCK_SIZE * 4); 
                        } else {
                            this.spawnCoin(x, y - (BLOCK_SIZE*0.5));
                        }
                    }
                } 
                else if (r < 0.7) { 
                    if (tooCloseForObstacle) return; 
                    
                    this.lastObstacleX = x;
                    const obsY = y - (BLOCK_SIZE * 0.3);
                    const obs = this.obstacles.create(x, obsY, `obstacle_${this.level}`); 
                    obs.setDisplaySize(BLOCK_SIZE*1.6, BLOCK_SIZE*1.6); 
                    obs.refreshBody();
                    obs.body.setSize(BLOCK_SIZE*0.5, BLOCK_SIZE*0.5);
                    const off = (BLOCK_SIZE*1.6 - BLOCK_SIZE*0.5) / 2;
                    obs.body.setOffset(off, off);
                } 
                else if (r < 0.78) { 
                    if (tooCloseForObstacle) return;
                    
                    this.lastAirObstacleX = x;
                    const obs = this.obstacles.create(x, y - (BLOCK_SIZE * 2.0), `obstacle_air_${this.level}_1`);
                    obs.play(`fly_${this.level}`);
                    obs.setDisplaySize(BLOCK_SIZE*1.6, BLOCK_SIZE*1.6); 
                    obs.refreshBody();
                    obs.body.setSize(BLOCK_SIZE*0.5, BLOCK_SIZE*0.5);
                    const off = (BLOCK_SIZE*1.6 - BLOCK_SIZE*0.5) / 2;
                    obs.body.setOffset(off, off);
                    this.tweens.add({targets: obs, y: obs.y + 50, yoyo: true, duration: 1000, repeat: -1});
                }
                else if (r < 0.85) { 
                    const timeSinceLast = this.time.now - this.lastPowerupTime;
                    const requiredInterval = Phaser.Math.Between(10000, 15000);
                    if (this.time.now - this.gameStartTime < 5000) return;
                    if (timeSinceLast < requiredInterval) return;
                    
                    this.lastPowerupTime = this.time.now;
                    this.lastPowerupX = x;
                    const pTypes = ['shield', 'magnet', 'doublejump'];
                    const type = pTypes[Phaser.Math.Between(0, 2)];
                    this.spawnFloatingItem(x, y, type);
                } 
            }

            spawnFloatingItem(x, y, type) {
                let imgKey = type + '_item';
                if (type === 'life') imgKey = 'life_icon'; 
                
                const p = this.powerups.create(x, y, imgKey).setData('type', type);
                p.setDisplaySize(BLOCK_SIZE*0.7, BLOCK_SIZE*0.7); 
                p.refreshBody(); 
                p.body.setSize(BLOCK_SIZE*0.7, BLOCK_SIZE*0.7);
                this.addFloatingAnim(p);
            }
            
            spawnFullWordPattern(startX, startY) {
                const word = ['O', 'Q', 'E', 'P'];
                const spacingX = BLOCK_SIZE * 0.4;
                const spacingY = BLOCK_SIZE * 0.4;
                const letterSpacing = BLOCK_SIZE * 2.5; 
                word.forEach((char, index) => {
                    const pattern = LETTER_PATTERNS[char];
                    const letterOffsetX = index * letterSpacing;
                    for (let r = 0; r < pattern.length; r++) {
                        for (let c = 0; c < pattern[r].length; c++) {
                            if (pattern[r][c] === 'X') {
                                const coin = this.coins.create(startX + letterOffsetX + (c * spacingX), startY + (r * spacingY), `coin_${this.level}`);
                                coin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); coin.refreshBody(); coin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                                this.addCoinWiggle(coin);
                            }
                        }
                    }
                });
            }

            spawnCoinArc(startX, baseY) {
                const radius = BLOCK_SIZE;
                const steps = 5;
                const stepAngle = Math.PI / (steps - 1);
                for(let i=0; i<steps; i++) {
                    const angle = Math.PI + (i * stepAngle); 
                    const cX = startX + (i * (BLOCK_SIZE*0.8));
                    const cY = baseY + (Math.sin(angle) * radius);
                    const coin = this.coins.create(cX, cY, `coin_${this.level}`);
                    coin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                    coin.refreshBody();
                    coin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                    this.addCoinWiggle(coin);
                }
            }

            spawnCoinLine(startX, startY) {
                for(let i=0; i<5; i++) {
                    const coin = this.coins.create(startX + (i*(BLOCK_SIZE*0.5)), startY, `coin_${this.level}`);
                    coin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                    coin.refreshBody();
                    coin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                    this.addCoinWiggle(coin);
                }
            }

            spawnCoinZigZag(startX, startY) {
                const offsets = [0, -40, 0, -40, 0];
                for(let i=0; i<5; i++) {
                    const coin = this.coins.create(startX + (i*(BLOCK_SIZE*0.6)), startY + offsets[i], `coin_${this.level}`);
                    coin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                    coin.refreshBody();
                    coin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                    this.addCoinWiggle(coin);
                }
            }

            spawnCoinTriangle(startX, startY) {
                const topCoin = this.coins.create(startX + (BLOCK_SIZE*0.5), startY, `coin_${this.level}`);
                topCoin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                topCoin.refreshBody(); topCoin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                this.addFloatingAnim(topCoin);

                const b1 = this.coins.create(startX, startY + (BLOCK_SIZE*0.6), `coin_${this.level}`);
                b1.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                b1.refreshBody(); b1.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                this.addFloatingAnim(b1);

                const b2 = this.coins.create(startX + BLOCK_SIZE, startY + (BLOCK_SIZE*0.6), `coin_${this.level}`);
                b2.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                b2.refreshBody(); b2.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                this.addFloatingAnim(b2);
            }

            addFloatingAnim(target) {
                const startDelay = Phaser.Math.Between(0, 1000);
                const dur = Phaser.Math.Between(350, 450);
                this.tweens.add({
                    targets: target,
                    angle: { from: -15, to: 15 },
                    yoyo: true, repeat: -1, duration: dur, ease: 'Sine.easeInOut',
                    delay: startDelay
                });
                this.tweens.add({
                    targets: target,
                    y: target.y - 20,
                    yoyo: true, repeat: -1, duration: 800, ease: 'Sine.easeInOut',
                    delay: startDelay
                });
            }

            spawnCoin(x, y) {
                const coin = this.coins.create(x, y, `coin_${this.level}`);
                coin.setDisplaySize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4);
                coin.refreshBody();
                coin.body.setSize(BLOCK_SIZE*0.4, BLOCK_SIZE*0.4); 
                this.addCoinWiggle(coin);
            }

            addCoinWiggle(coin) {
                const startDelay = Phaser.Math.Between(0, 500);
                this.tweens.add({ targets: coin, angle: { from: -15, to: 15 }, yoyo: true, repeat: -1, duration: 400, ease: 'Sine.easeInOut', delay: startDelay });
                this.tweens.add({ targets: coin, y: coin.y - 15, yoyo: true, repeat: -1, duration: Phaser.Math.Between(600, 1000), ease: 'Sine.easeInOut', delay: startDelay });
            }

            spawnParticles(x, y, type, color) {
                if (type === 'mix') {
                    const emitterS = this.add.particles(x, y, 'particle_star_4', {
                        speed: { min: 200, max: 400 }, angle: { min: 0, max: 360 }, scale: { start: 1, end: 0 }, lifespan: 500, tint: color, quantity: 8, emitting: false
                    });
                    emitterS.explode();
                    const emitterR = this.add.particles(x, y, 'particle_round', {
                        speed: { min: 100, max: 300 }, angle: { min: 0, max: 360 }, scale: { start: 0.5, end: 0 }, lifespan: 600, tint: 0xffffff, quantity: 8, emitting: false, blendMode: 'ADD'
                    });
                    emitterR.explode();
                    return;
                }

                const texture = type === 'round' ? 'particle_round' : 'particle_star';
                const emitter = this.add.particles(x, y, texture, {
                    speed: { min: 200, max: 400 }, angle: { min: 0, max: 360 }, scale: { start: 1, end: 0 }, lifespan: 500, tint: color, quantity: 15, emitting: false
                });
                emitter.explode();
            }

            collectCoin(player, coin) {
                coin.destroy();
                this.score += 1;
                this.updateHUD();
                this.spawnParticles(coin.x, coin.y, 'mix', 0xffff00); 
                if(this.coinSound) this.coinSound.play();
            }

            collectPowerup(p, item) {
                const type = item.getData('type');
                item.destroy();
                
                if (type === 'life') {
                    if (this.lives < 3) {
                        this.lives++;
                    }
                    this.spawnParticles(p.x, p.y, 'round', 0xff0000); 
                    if(this.powerSound) this.powerSound.play();
                    this.updateHUD();
                    return; 
                }

                this.score += 1;
                this.updateHUD();
                let color = 0xffffff;
                if (type === 'shield') color = 0x00ff00; 
                else if (type === 'magnet') color = 0x9333ea; 
                else if (type === 'doublejump') color = 0x00ffff; 
                this.spawnParticles(p.x, p.y, 'round', color);

                if(this.powerSound) this.powerSound.play();

                this.powerupIconUI.setTexture(type + '_item').setVisible(true);
                this.powerupBarBg.setVisible(true);
                this.powerupBar.setVisible(true).width = 100; 
                if (this.powerupTween) this.powerupTween.stop();
                this.powerupTween = this.tweens.add({
                    targets: this.powerupBar, width: 0, duration: 5000,
                    onComplete: () => {
                        this.powerupIconUI.setVisible(false); this.powerupBarBg.setVisible(false); this.powerupBar.setVisible(false); this.hasDoubleJump = false; 
                    }
                });
                if(type === 'shield') {
                    this.hasShield = true; this.shieldFx.setVisible(true);
                    this.time.delayedCall(5000, () => { this.hasShield = false; this.shieldFx.setVisible(false); });
                } else if (type === 'magnet') {
                    this.hasMagnet = true; this.magnetFx.setVisible(true);
                    this.time.delayedCall(5000, () => { this.hasMagnet = false; this.magnetFx.setVisible(false); });
                } else if (type === 'doublejump') {
                    this.hasDoubleJump = true;
                }
            }

            hitObstacle(p, o) {
                if(this.hasShield) { o.destroy(); this.hasShield=false; this.shieldFx.setVisible(false); return; }
                if(this.isInvincible) return; 
                
                if(this.hitSound) this.hitSound.play();

                this.isStunned = true;
                this.player.setTexture(`${userData.character}_hit`);
                this.player.setVelocity(0,0);
                this.player.body.setAllowGravity(false);
                
                this.spawnParticles(p.x, p.y, 'star', 0xff0000); 
                o.destroy();

                this.tweens.add({
                    targets: this.player,
                    x: '+=10', duration: 50, yoyo: true, repeat: 10,
                    onComplete: () => { this.recoverFromHit(); }
                });
            }

            recoverFromHit() {
                this.takeDamage('hit');
                if (this.isGameOver) return;
                this.isStunned = false;
                this.player.body.setAllowGravity(true);
                this.player.play('run');
                this.isInvincible = true;
                this.tweens.add({
                    targets: this.player, alpha: 0.5, duration: 100, yoyo: true, repeat: 10,
                    onComplete: () => { this.isInvincible = false; this.player.alpha = 1; }
                });
            }

            takeDamage(type) {
                this.lives--; 
                this.score = Math.max(0, this.score - 5);
                this.updateHUD();
                
                if (type === 'fall') {
                    this.spawnParticles(this.player.x, this.player.y, 'star', 0xff0000);
                    if(this.hitSound) this.hitSound.play();
                    
                    if (this.lives > 0) {
                        this.player.y = this.scale.height * 0.2; 
                        this.player.setVelocity(0, 0);
                        this.isInvincible = true;
                        this.tweens.add({
                            targets: this.player, alpha: 0.5, duration: 100, yoyo: true, repeat: 15,
                            onComplete: () => { this.isInvincible = false; this.player.alpha = 1; }
                        });
                        return;
                    }
                }
                
                if(this.lives <= 0) {
                    (async () => {
                        this.isGameOver = true; this.physics.pause();
                        if(this.bgMusic) this.bgMusic.stop();

                        document.getElementById('end-name').innerText = userData.name;
                        document.getElementById('final-score').innerText = this.score;
                        document.getElementById('game-over-screen').classList.remove('hidden');
                        document.getElementById('game-over-screen').style.display = 'flex';

                        await saveScore(this.score);
                        renderGameOverLeaderboard();
                    })();
                }
            }

            enterPortal(p, portal) {
                if(this.level === 3) { // WIN
                    (async () => {
                        this.isGameOver = true; this.physics.pause();
                        if(this.bgMusic) this.bgMusic.stop();
                        
                        document.getElementById('end-name').innerText = userData.name + " " + I18N[userData.lang].win;
                        document.getElementById('final-score').innerText = this.score;
                        document.getElementById('game-over-screen').classList.remove('hidden');
                        document.getElementById('game-over-screen').style.display = 'flex';

                        await saveScore(this.score);
                        renderGameOverLeaderboard();
                    })();
                    return;
                }
                portal.destroy();
                this.cameras.main.flash(1000, 255, 255, 255);
                this.isInvincible = true;
                this.lifePowerupSpawned = false;
                
                this.tweens.add({
                    targets: this.player, alpha: 0.5, duration: 100, yoyo: true, repeat: 15,
                    onComplete: () => { this.isInvincible = false; this.player.alpha = 1; }
                });
                this.level++;
                this.score += 5;
                this.distance = 0;
                this.currentSpeed = GAME_CONFIG.startSpeed + ((this.level - 1) * 200); 
                
                this.bg.setTexture(`bg_${this.level}`);
                
                this.showLevelName();
                this.levelStartTime = this.time.now;
                this.portalSpawned = false;
            }

            createHUD() {
                this.hudContainer = this.add.container(0,0).setScrollFactor(0).setDepth(100);
                this.lifeIcons = [];
                for(let i=0; i<3; i++) {
                    const icon = this.add.image(60 + (i*70), 60, 'life_icon').setDisplaySize(60,60);
                    this.hudContainer.add(icon);
                    this.lifeIcons.push(icon);
                }
                
                const lvlStr = userData.lang === 'ar' ? `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${this.level}` : `LEVEL ${this.level}`;
                this.levelText = this.add.text(280, 60, lvlStr, { fontSize:'32px', fontFamily: userData.lang==='ar'?'Cairo':'Roboto', fontStyle:'bold', color:'#fff', stroke:'#000', strokeThickness:6 }).setOrigin(0,0.5);
                this.hudContainer.add(this.levelText);

                this.powerupIconUI = this.add.image(80, 130, 'shield_item').setDisplaySize(50,50).setVisible(false);
                this.hudContainer.add(this.powerupIconUI);
                this.powerupBarBg = this.add.rectangle(120, 130, 200, 20, 0x000000).setOrigin(0, 0.5).setVisible(false).setStrokeStyle(2, 0xffffff);
                this.hudContainer.add(this.powerupBarBg);
                this.powerupBar = this.add.rectangle(122, 130, 196, 16, 0x00ff00).setOrigin(0, 0.5).setVisible(false);
                this.hudContainer.add(this.powerupBar);
                const t = I18N[userData.lang];
                this.scoreText = this.add.text(this.scale.width-40, 60, `${t.score}: 0`, { fontSize:'48px', fontFamily: userData.lang==='ar'?'Cairo':'Roboto', color:'#fff', stroke:'#000', strokeThickness:6 }).setOrigin(1,0.5);
                this.hudContainer.add(this.scoreText);
            }

            updateHUD() {
                this.scoreText.setText(`${I18N[userData.lang].score}: ${this.score}`);
                this.lifeIcons.forEach((icon,i) => icon.setVisible(i < this.lives));
                const lvlStr = userData.lang === 'ar' ? `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${this.level}` : `LEVEL ${this.level}`;
                this.levelText.setText(lvlStr);
            }

            showLevelName() {
                const lvlInfo = LEVEL_NAMES[this.level];
                const txt = lvlInfo ? (userData.lang === 'ar' ? lvlInfo.ar : lvlInfo.en) : `Level ${this.level}`;
                const t = this.add.text(this.scale.width/2, this.scale.height/2, txt, { fontSize:'96px', fontFamily: userData.lang === 'ar' ? 'Cairo' : 'Roboto', fontStyle:'bold', color:'#fff', stroke:'#000', strokeThickness:8 }).setOrigin(0.5).setScrollFactor(0).setAlpha(0);
                this.tweens.add({ targets:t, alpha:1, duration:1000, hold:2000, yoyo:true, onComplete:()=>t.destroy() });
            }

            createDemoAssets() {
                const g = this.make.graphics();
                g.fillStyle(0xff0000); g.fillCircle(32,32,32); g.generateTexture('life_icon',64,64); g.clear();
                g.fillStyle(0x00ff00); g.fillCircle(32,32,32); g.generateTexture('shield_item',64,64); g.lineStyle(4,0x00ff00); g.strokeCircle(32,32,30); g.generateTexture('shield_overlay',64,64); g.clear();
                g.fillStyle(0x9333ea); g.fillRect(0,0,64,64); g.generateTexture('magnet_item',64,64); g.lineStyle(4,0x9333ea); g.strokeCircle(32,32,40); g.generateTexture('magnet_effect',128,128); g.clear();
                g.fillStyle(0x00ffff); g.beginPath(); g.moveTo(0,64); g.lineTo(64,0); g.lineTo(64,64); g.fillPath(); g.generateTexture('doublejump_item', 64, 64); g.clear();
                [0x00ffff, 0x00aaaa, 0x008888].forEach((c,i) => { g.fillStyle(c); g.fillRect(0,0,128,200); g.generateTexture(`portal_${i+1}`,128,200); g.clear(); });
                const drawChar = (k,c) => { 
                    g.fillStyle(c); g.fillRect(0,0,128,128); g.generateTexture(`${k}_run_1`,128,128);
                    g.fillStyle(c==0x3b82f6?0x1d4ed8:0xbe185d); g.fillRect(0,0,128,128); g.generateTexture(`${k}_run_2`,128,128);
                    g.fillStyle(c); g.fillRect(0,0,128,128); g.generateTexture(`${k}_run_3`,128,128); 
                    g.fillStyle(c==0x3b82f6?0x1d4ed8:0xbe185d); g.fillRect(0,0,128,128); g.generateTexture(`${k}_run_4`,128,128); 
                    g.fillStyle(0xffff00); g.fillRect(0,0,128,128); g.generateTexture(`${k}_jump`,128,128);
                    g.fillStyle(0xff0000); g.fillRect(0,0,128,128); g.generateTexture(`${k}_hit`,128,128); g.generateTexture(`${k}_fall`,128,128); g.clear();
                };
                drawChar('rahal', 0x3b82f6); drawChar('rahala', 0xec4899);
                const colors = [0x22c55e, 0xeab308, 0xf97316, 0xef4444, 0x6366f1];
                for(let i=1; i<=5; i++) {
                    const c = colors[i-1];
                    g.fillStyle(0x111111); g.fillRect(0,0,512,512); g.fillStyle(c,0.5); g.fillCircle(100,100,40); g.generateTexture(`bg_${i}`,512,512); g.clear();
                    g.fillStyle(c); g.fillRect(0,0,128,128); g.lineStyle(4,0xffffff); g.strokeRect(0,0,128,128); g.generateTexture(`block_${i}`,128,128); g.clear();
                    g.fillStyle(0xff0000); g.beginPath(); g.moveTo(0,64); g.lineTo(32,0); g.lineTo(64,64); g.fillPath(); g.generateTexture(`obstacle_${i}`,64,64); g.clear();
                    g.fillStyle(0x550000); g.fillCircle(32,32,25); g.generateTexture(`obstacle_air_${i}_1`,64,64); g.clear();
                    g.fillStyle(0x880000); g.fillCircle(32,32,25); g.generateTexture(`obstacle_air_${i}_2`,64,64); g.clear();
                    g.fillStyle(0xffd700); g.fillCircle(16,16,16); g.generateTexture(`coin_${i}`,32,32); g.clear();
                }
            }
        }
    </script>
</body>
</html>
